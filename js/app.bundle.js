(()=>{var I=class{static detach(e){var t;(t=e==null?void 0:e.parentElement)==null||t.removeChild(e)}};var P=class{constructor(){this._shouldPropagate=!0;this._bindings=[]}static create(){return new P}add(e,t,i=0){this.registerListener(e,!1,t,i)}addAndCall(e,t,i=0){this.registerListener(e,!1,t,i),t=t||this,e.call(t)}addOnce(e,t,i=0){this.registerListener(e,!0,t,i)}registerListener(e,t,i,r=0){let s=this.indexOfListener(e,i),a=null;if(s!==-1){if(a=this._bindings[s],a.isOnce!==t)throw new Error("You cannot add"+(t?"":"Once")+"() then add"+(t?"Once":"")+"() the same listener without removing the relationship first.")}else a={listener:e,context:i,isOnce:t,priority:r},this.addBinding(a)}addBinding(e){let t=this._bindings.length;do--t;while(this._bindings[t]&&e.priority<=this._bindings[t].priority);this._bindings.splice(t+1,0,e)}indexOfListener(e,t){for(let i=this._bindings.length-1;i>=0;--i){let r=this._bindings[i];if(r.listener===e&&r.context===t)return i}return-1}has(){}halt(){this._shouldPropagate=!1}remove(e,t){let i=this.indexOfListener(e,t);return i!==-1?(this._bindings.splice(i,1),!0):!1}removeAll(){this._bindings.length=0}dispatch(...e){let t=Array.prototype.slice.call(arguments);this._shouldPropagate=!0;let i=this._bindings;for(let r=i.length-1;r>=0&&!(i[r].listener.apply(i[r].context,t)===!1||!this._shouldPropagate);--r);}dispose(){this.removeAll()}get bindings(){return this._bindings}};var A=class{constructor(e){this.signals={filesSelected:P.create()};this.onDragCancel=e=>{e.preventDefault(),this._uploadArea.classList.remove("active")};this._inputElement=document.createElement("input"),this._inputElement.type="file",this._inputElement.accept=e,this._inputElement.addEventListener("change",t=>{let i=this._inputElement.files;this.processFile(i)}),this._uploadArea=document.getElementById("uploadArea"),document.addEventListener("dragover",t=>{t.preventDefault(),this._uploadArea.classList.add("active")}),document.addEventListener("drop",t=>{t.preventDefault();let i=t.dataTransfer.files;this.processFile(i),this._uploadArea.classList.remove("active")}),document.addEventListener("dragleave",this.onDragCancel),this._uploadArea.addEventListener("click",()=>{this._inputElement.click()})}processFile(e){this.signals.filesSelected.dispatch(e)}destroy(){I.detach(this._inputElement),I.detach(this._uploadArea);for(let e in this.signals)this.signals[e].removeAll()}};var v=class{static lengthOfSquared(e){let t=0;for(let i of e)t+=i*i;return t}static lengthOf(e){return Math.sqrt(v.lengthOfSquared(e))}static normalize(e){let t=v.lengthOf(e);for(let i=0;i<e.length;++i)e[i]/=t;return e}static getWorldPositionFromUV(e,t){let i=[Math.cos(e)*Math.sin(t),Math.cos(t),Math.sin(e)*Math.sin(t)];return v.normalize(i)}};var l=class{static clamp(e,t,i){return e<=t?t:e>=i?i:e}static isValidNumber(e){return!(e===null||e===void 0||isNaN(e)||e===Infinity||e===-Infinity)}static deg2rad(e){return Math.PI/180*e}static rad2deg(e){return 180/Math.PI*e}static getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}static getForwardLengthFromFOV(e){return 1/Math.tan(l.deg2rad(e/2))}static getNormalizedCursorCoords(e,t,i){return[2*(e/i[0]-.5),2*((i[1]-t)/i[1]-.5)]}static getSphereSurfacePointFromUV(e,t){let i=[Math.cos(e)*Math.sin(t),Math.cos(t),Math.sin(e)*Math.sin(t)];return v.normalize(i)}static getUVFromSphereSufracePoint(e){let t=v.normalize(e),i=1-(Math.PI-Math.atan2(t[2],t[0]))/(2*Math.PI),r=(Math.PI/2-Math.asin(-t[1]))/Math.PI;return[i,r]}static getLongitudeLatitudeFromUV(e){return[2*Math.PI*((e[0]+.5)%1),Math.PI*(e[1]-.5)]}static isPowerOfTwo(e){return(e&e-1)==0&&e!==0}static ceilPowerOfTwo(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}};var V=class{static get DEFAULT_ZOOM_FACTOR(){return V.MIN_ZOOM_FACTOR}static get isFullscreenAvailable(){let e=document.body;return!!e.requestFullscreen||!!e.webkitRequestFullscreen||!!e.mozRequestFullScreen||!!e.msRequestFullscreen}static get isIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}static get isMac(){return/Mac/.test(navigator.userAgent)&&!window.MSStream}},o=V;o.ANIMATION_DURATION=400,o.DAMPING_DURATION=2e3,o.MOUSE_BUTTON={LEFT:0,MIDDLE:1,RIGHT:2},o.TRANSITION_DURATION=400,o.FOV=75,o.POINTER_SENSITIVITY=1.2,o.MIN_ZOOM_FACTOR=1,o.WORLD_UP=[0,1,0],o.CAMERA_POSITION=[0,0,0],o.AUTOROTATION_SPEEDS={default:3e-5,fast:9e-4},o.MOUSE_BUTTON={LEFT:0,MIDDLE:1,RIGHT:2};var D=class{static get vertexShader(){return`precision highp float;attribute vec3 vertPosition;varying vec3 vsRay;uniform float zoomFactor;uniform vec3 fw;uniform float ratio;void main() { gl_Position = vec4(zoomFactor * vertPosition, 1.0);vec3 worldUp = vec3(0, 1, 0);vec3 camRight = normalize(cross(fw, worldUp));vec3 camUp = normalize(cross(camRight, fw));vec3 corner = fw * ${l.getForwardLengthFromFOV(o.FOV)} + ratio*camRight*vertPosition.x + camUp*vertPosition.y;vsRay = corner;}`}static get fragmentShader(){return`#ifdef GL_EXT_shader_texture_lod
	#extension GL_EXT_shader_texture_lod : enable
#endif

precision highp float;varying vec3 vsRay;varying vec3 movementDirection;uniform sampler2D textureMap;uniform float maxTextureLevel;uniform bool isBlurOn;uniform bool isX360;uniform bool isY180;uniform vec4 textureViewBox;float intersectSphere(vec3 ro, vec3 rd) { vec3 rc = ro;float c = dot(rc, rc) - 1.0;float b = dot(rd, rc);float d = b*b - c;float t = -b + sqrt(abs(d));return t;} float getInterpolation(in float a, in float b, in float x) { return ((x - a) / (b - a));} vec3 getColor(in vec2 sphereUV, in vec4 textureViewBox) { vec2 imageUV = vec2( getInterpolation(textureViewBox.x, textureViewBox.z, sphereUV.x + (textureViewBox.z + textureViewBox.x) - 1.0), getInterpolation(textureViewBox.y, textureViewBox.w, sphereUV.y + (textureViewBox.y + textureViewBox.w) - 1.0) );float mixMultiplier = 0.0;float blurMultiplier = 0.0;bool transitionNeeded = false;float transitionSize = isBlurOn ? 0.01 : 0.001;if (1.0 - transitionSize > textureViewBox.w && sphereUV.y < (1.0 - textureViewBox.w + transitionSize)) { transitionNeeded = true;blurMultiplier = getInterpolation(1.0 - textureViewBox.w + transitionSize, 0.0, sphereUV.y);mixMultiplier = smoothstep(1.0 - textureViewBox.w + transitionSize, 1.0 - textureViewBox.w, sphereUV.y);} else if (transitionSize < textureViewBox.y && sphereUV.y > (1.0 - textureViewBox.y - transitionSize)) { transitionNeeded = true;blurMultiplier = getInterpolation(1.0 - textureViewBox.y - transitionSize, 1.0, sphereUV.y);mixMultiplier = smoothstep(1.0 - textureViewBox.y - transitionSize, 1.0 - textureViewBox.y, sphereUV.y);} if (1.0 - transitionSize > textureViewBox.z && sphereUV.x < (1.0 - textureViewBox.z + transitionSize)) { transitionNeeded = true;blurMultiplier = max(blurMultiplier, getInterpolation(1.0 - textureViewBox.z + transitionSize, 0.0, sphereUV.x));mixMultiplier = max(mixMultiplier, smoothstep(1.0 - textureViewBox.z + transitionSize, 1.0 - textureViewBox.z, sphereUV.x));} else if (transitionSize < textureViewBox.x && sphereUV.x > (1.0 - textureViewBox.x - transitionSize)) { transitionNeeded = true;blurMultiplier = max(blurMultiplier, getInterpolation(1.0 - textureViewBox.x - transitionSize, 1.0, sphereUV.x));mixMultiplier = max(mixMultiplier, smoothstep(1.0 - textureViewBox.x - transitionSize, 1.0 - textureViewBox.x, sphereUV.x));} vec3 baseSample = texture2DLodEXT(textureMap, imageUV, 0.0).rgb;if (isBlurOn && transitionNeeded) { if (transitionNeeded) { blurMultiplier = clamp((0.5 + sqrt(blurMultiplier)) / 1.5, 0.0, 1.0);} bool shouldFixVerticalSeam = !isX360 && isY180;float medianLodLevel = blurMultiplier * max(1.0, (maxTextureLevel - (shouldFixVerticalSeam ? 0.0 : 0.5)));return mix( baseSample, ( (shouldFixVerticalSeam ? vec3(0.0) : 1.0 * texture2DLodEXT(textureMap, imageUV, medianLodLevel - 1.0).rgb) + 2.0 * texture2DLodEXT(textureMap, imageUV, medianLodLevel).rgb + 1.0 * texture2DLodEXT(textureMap, imageUV, medianLodLevel + 1.0).rgb ) / (4.0 - (shouldFixVerticalSeam ? 1.0 : 0.0)), mixMultiplier );} else { return mix( baseSample, vec3(0.1, 0.1, 0.11), mixMultiplier );} } void main() { vec3 rayDirection = normalize(vsRay);float t = intersectSphere(vec3(0.0, 0.0, 0.0), rayDirection);vec3 hitPoint = vec3(0.0, 0.0, 0.0) + rayDirection * t;vec2 sphereUV = vec2( 0.5 + atan(hitPoint.z, hitPoint.x) / (2.0 * 3.14159265359), 0.5 - asin(hitPoint.y) / 3.14159265359 );vec3 color = getColor(sphereUV, textureViewBox);gl_FragColor = vec4(color, 1.0);}`}};var w=class{constructor(e,t,i){this._glVersion=1;this._ratio={value:1,loc:null};this._maxTextureLevel={value:0,loc:null};this._isBlurOn={value:!1,loc:null};this._isX360={value:!1,loc:null};this._isY180={value:!1,loc:null};this._zoomFactorLoc=null;this._forward={value:[0,0,-1],loc:null};this._texture={texValue:null,texLoc:null,viewBox:w.defaultViewBox,viewBoxLoc:null};this._isInitialTexture=!0;this._gl=e,this._glVersion=t,this._isTextureLodExtensionAvailable=i,this._vertexShader=e.createShader(e.VERTEX_SHADER),this._fragmentShader=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(this._vertexShader,this.vertexShader),e.shaderSource(this._fragmentShader,this.fragmentShader);try{this.compileShaders(),this.initProgram(),this._ratio.loc=this._gl.getUniformLocation(this._program,"ratio"),this._zoomFactorLoc=this._gl.getUniformLocation(this._program,"zoomFactor"),this._forward.loc=this._gl.getUniformLocation(this._program,"fw"),this._texture.texLoc=this._gl.getUniformLocation(this._program,"texture"),this._texture.viewBoxLoc=this._gl.getUniformLocation(this._program,"textureViewBox"),this._maxTextureLevel.loc=this._gl.getUniformLocation(this._program,"maxTextureLevel"),this._isBlurOn.loc=this._gl.getUniformLocation(this._program,"isBlurOn"),this._isX360.loc=this._gl.getUniformLocation(this._program,"isX360"),this._isY180.loc=this._gl.getUniformLocation(this._program,"isY180")}catch(r){console.error(r)}}get vertexShader(){let e=D.vertexShader;return this.isWebGL2Supported&&(e=`#version 300 es
${e}`.replace(/varying/g,"out").replace(/attribute/g,"in")),e}get fragmentShader(){let e=D.fragmentShader;return this.isWebGL2Supported&&(e=`#version 300 es
${e}`.replace(/varying/g,"in").replace(/texture2DLodEXT/g,"textureLod").replace(/texture2D/g,"texture").replace(/precision highp float;/,`precision highp float;out vec4 outputColor;`).replace(/gl_FragColor/g,"outputColor")),e}get isWebGL2Supported(){return this._glVersion>=2}isTexturePOT(e){return l.isPowerOfTwo(e.width)&&l.isPowerOfTwo(e.height)}isBlurAvailable(e){return this.isWebGL2Supported?!0:this._isTextureLodExtensionAvailable&&this.isTexturePOT(e)}addLineNumbers(e){let t=e.split(`
`);for(let i=0;i<t.length;i++)t[i]=`${i+1}: ${t[i]}`;return t.join(`
`)}compileShaders(){this.compileShader(this._vertexShader),this.compileShader(this._fragmentShader)}compileShader(e){if(this._gl.compileShader(e),!this._gl.getShaderParameter(e,this._gl.COMPILE_STATUS)){let t=this._gl.getShaderSource(e);throw`Error compiling shader: ${this._gl.getShaderInfoLog(e)}: ${this.addLineNumbers(t)}`}}initProgram(){this._program=this._gl.createProgram(),this._gl.attachShader(this._program,this._vertexShader),this._gl.attachShader(this._program,this._fragmentShader),this.linkProgram(),this.validateProgram()}linkProgram(){if(this._gl.linkProgram(this._program),!this._gl.getProgramParameter(this._program,this._gl.LINK_STATUS)&&!this._gl.isContextLost())throw`Error linking program: ${this._gl.getError()}, ${this._gl.getProgramInfoLog(this._program)}`}validateProgram(){if(this._gl.validateProgram(this._program),!this._gl.getProgramParameter(this._program,this._gl.VALIDATE_STATUS))throw`Error validating program: ${this._gl.getProgramInfoLog(this._program)}`}setSize(e,t){this._ratio.value=e/t}loadTexture(e){this._texture.texValue=this._gl.createTexture();let t=this._texture;this._isInitialTexture&&(this._isInitialTexture=!1),t.viewBox=e.viewBox,this._maxTextureLevel.value=Math.log2(Math.max(e.textureData.width,e.textureData.height));let i=t.viewBox[2]-t.viewBox[0]==1,r=t.viewBox[3]-t.viewBox[1]==1;this._isX360.value=i,this._isY180.value=r;let a=!(i&&r)&&this.isBlurAvailable(e.textureData);this._isBlurOn.value=a;let n=this._gl;n.bindTexture(n.TEXTURE_2D,t.texValue),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,a&&i?n.REPEAT:n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a?n.LINEAR_MIPMAP_LINEAR:n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.RGB,n.RGB,n.UNSIGNED_BYTE,e.textureData),a&&n.generateMipmap(n.TEXTURE_2D),n.bindTexture(n.TEXTURE_2D,null)}setVec3Uniform(e,t){this._gl.uniform3fv(e,t)}setVec4Uniform(e,t){this._gl.uniform4fv(e,t)}setFloatUniform(e,t){this._gl.uniform1f(e,t)}setBoolUniform(e,t){this._gl.uniform1i(e,t?1:0)}setTextureData(e,t){this._gl.activeTexture(this._gl.TEXTURE0+t),this._gl.bindTexture(this._gl.TEXTURE_2D,e.texValue),this._gl.uniform1i(e.texLoc,t)}setTexture(e,t){this.setVec4Uniform(e.viewBoxLoc,e.viewBox),this.setTextureData(e,t)}updateUniforms(e){this.setFloatUniform(this._ratio.loc,this._ratio.value),this.setVec3Uniform(this._forward.loc,this._forward.value),this.setFloatUniform(this._zoomFactorLoc,e),this.setFloatUniform(this._maxTextureLevel.loc,this._maxTextureLevel.value),this.setBoolUniform(this._isBlurOn.loc,this._isBlurOn.value),this.setBoolUniform(this._isX360.loc,this._isX360.value),this.setBoolUniform(this._isY180.loc,this._isY180.value),this.setTexture(this._texture,0)}render(e,t){this._forward.value=e,this._gl.useProgram(this._program),this.updateUniforms(t),this._gl.drawArrays(this._gl.TRIANGLE_STRIP,0,4)}get program(){return this._program}static get defaultViewBox(){return[0,0,1,1]}static get defaultTextureData(){return{textureData:new ImageData(1,1),viewBox:this.defaultViewBox,headingAngle:0}}};var U=class{static readAsText(e){return new Promise((t,i)=>{let r=new FileReader;r.onload=()=>{t(r.result)},r.onerror=()=>{i((e==null?void 0:e.name)||"Error")},r.readAsText(e)})}static getValueFromTextByKey(e,t){let i=e.indexOf(t);if(i>-1){let r=e.indexOf('"',i+t.length+3);return e.substring(t.length+i+2,r)}else return null}};var B=["GPano:CroppedAreaImageHeightPixels","GPano:CroppedAreaImageWidthPixels","GPano:CroppedAreaLeftPixels","GPano:CroppedAreaTopPixels","GPano:FullPanoHeightPixels","GPano:FullPanoWidthPixels","GPano:InitialViewHeadingDegrees"],p=class{static createWorker(e){return new Worker(URL.createObjectURL(new Blob([`(${e})()`])))}static getImage(e,t,i){return typeof createImageBitmap!="undefined"?new Promise((r,s)=>{function a(n){n.data.src===e&&(p.worker.removeEventListener("message",a),n.data.error&&s(n.data.error),r(n.data.bitmap))}p.worker.addEventListener("message",a),p.worker.postMessage({url:e,maxTextureSize:t,isWebGL2Supported:i})}):new Promise(async(r,s)=>{let a=await p.getImageElement(e),n=Math.max(a.width,a.height);if(t<n){let u=Math.min(n,t),m=a.width/a.height,d={width:null,height:null};m>=1?(d.width=u,d.height=d.width/m):(d.height=u,d.width=d.width*m),p._canvas.width=d.width,p._canvas.height=d.height,p._ctx.drawImage(a,0,0,d.width,d.height),p._canvas.toBlob(async c=>{let f=await p.getImageElement(URL.createObjectURL(c));r(f)})}else r(a)})}static async getImageElement(e){return new Promise((t,i)=>{let r=document.createElement("img");r.setAttribute("crossorigin","anonymous"),r.onload=()=>{t(r)},r.onerror=()=>{i(r)},r.src=e})}static async getCachedImageElement(e){return p._cache[e]||(p._cache[e]=this.getImageElement(e)),p._cache[e]}static async getXMPMetaDataFromImageFile(e){let t=await U.readAsText(e),i={};for(let r of B)i[r]=parseFloat(U.getValueFromTextByKey(t,r));return i}static async getMetaDataFromFile(e){let t=w.defaultViewBox,i=URL.createObjectURL(e),r=await this.getCachedImageElement(i),s=await this.getXMPMetaDataFromImageFile(e);if(s["GPano:FullPanoWidthPixels"]){let h=s["GPano:FullPanoWidthPixels"],u=s["GPano:FullPanoHeightPixels"],m=s["GPano:CroppedAreaLeftPixels"],d=s["GPano:CroppedAreaTopPixels"],c=s["GPano:CroppedAreaImageWidthPixels"],f=s["GPano:CroppedAreaImageHeightPixels"];(h!==c||u!==f)&&(t[0]=m/h,t[1]=(u-f-d)/u,t[2]=(m+c)/h,t[3]=(u-d)/u)}else{let h=r.width/2-r.height,u=r.height+h;if(h>1){let m=h/2;t[1]=m/u,t[3]=(u-m)/u}}let a=(s["GPano:InitialViewHeadingDegrees"]+180)%360,n=l.isValidNumber(a)?l.deg2rad(a):0;return{viewBox:t,headingAngle:n,originalWidth:r.width,originalHeight:r.height,imageUrl:i}}static getNewImageElement(e){return new Promise((t,i)=>{let r=document.createElement("img");r.setAttribute("crossorigin","anonymous"),r.onload=()=>{t(r)},r.onerror=()=>{i(r)},r.src=e})}static async getImageForTexture(e,t,i){let r=await p.getMetaDataFromFile(e);return{textureData:await p.getImage(r.imageUrl,t,i),viewBox:r.viewBox}}},S=p;S._canvas=document.createElement("canvas"),S._ctx=p._canvas.getContext("2d"),S._cache={},S.worker=p.createWorker(()=>{self.addEventListener("message",e=>{let t=e.data.url,i=e.data.maxTextureSize,r=e.data.isWebGL2Supported;fetch(t).then(s=>{s.blob().then(a=>{createImageBitmap(a).then(n=>{let h=Math.max(n.width,n.height);if(i<h){let m=Math.min(h,i),d=n.width/n.height,c={width:null,height:null};if(d>=1?(c.width=m,c.height=c.width/d):(c.height=m,c.width=c.height*d),!r){let f=L=>(L&L-1)==0&&L!==0,y=L=>Math.pow(2,Math.ceil(Math.log(L)/Math.LN2));f(Math.max(c.width,c.height))&&(c.height<c.width?c.height=y(c.height):c.width<c.height&&(c.width=l.ceilPowerOfTwo(c.width)))}createImageBitmap(n,0,0,n.width,n.height,{resizeWidth:c.width,resizeHeight:c.height}).then(f=>{self.postMessage({src:t,bitmap:f},[f])})}else self.postMessage({src:t,bitmap:n},[n])})})})})});var b;(function(t){t[t.EASE_OUT=0]="EASE_OUT",t[t.EASE_IN_OUT=1]="EASE_IN_OUT"})(b||(b={}));var x=class{constructor(e,t,i=0,r=o.ANIMATION_DURATION,s=!0){this._timeStampAtSetEnd=0;this._min=-Infinity;this._max=Infinity;this._hasChanged=!1;this._prevDeltaValue=0;this._prevTimeStamp=1;this._prevDeltaTime=1;this._easing=0;this._timeoutId=-1;this._originalStart=e,this._start=e,this._originalEnd=t,this._end=t,this._value=this._start,this._originalAnimationDuration=this._animationDuration=r,this._easing=i,this._triggerRender=s}static removeFromActiveOnes(e){x._activeInstances=x._activeInstances.filter(t=>t!==e)}static addToActiveOnes(e){x._activeInstances.includes(e)||x._activeInstances.push(e)}static updateActiveOnes(e){let t=!1;for(let i of x._activeInstances)t=t||i._triggerRender,i.update(e);return t}smoothStep(e){if(e<this._animationDuration){let t=e/this._animationDuration;return l.clamp(t**2*(3-2*t)*(this._end-this._start)+this._start,this._min,this._max)}else return this._end=l.clamp(this._end,this._min,this._max),this._end}exponentialOut(e){if(e<this._animationDuration){let t=e/this._animationDuration;return l.clamp((1-2**(-10*t))*(1024/1023)*(this._end-this._start)+this._start,this._min,this._max)}else return this._end=l.clamp(this._end,this._min,this._max),this._end}getNextValue(e){return this._easing===1?this.smoothStep(e):this.exponentialOut(e)}increaseEndBy(e,t=!1){this.setEnd(this._end+e,t)}decreaseEndBy(e,t=!1){this.setEnd(this._end-e,t)}setEnd(e,t=!1,i=this._originalAnimationDuration){this._animationDuration=i;let r=t?l.clamp(e,this._min,this._max):e;x.addToActiveOnes(this),this._start=this._value,this._end=r,this._timeStampAtSetEnd=_.timeStamp,t||(clearTimeout(this._timeoutId),this._timeoutId=setTimeout(()=>{this._end=l.clamp(this._end,this._min,this._max)},this._animationDuration))}reset(e,t,i=this._originalAnimationDuration){this._animationDuration=i,x.addToActiveOnes(this),this._start=e!=null?e:this._originalStart,this._end=t!=null?t:this._originalEnd,this._timeStampAtSetEnd=_.timeStamp}update(e){this._prevDeltaTime=e-this._prevTimeStamp;let t=e-this._timeStampAtSetEnd,i=this._value;this._value=this.getNextValue(t),this._prevDeltaValue=this._value-i,this._prevTimeStamp=e,this._value===i?(this._start=this._end,this._hasChanged=!1,x.removeFromActiveOnes(this)):this._hasChanged=!0}get animationDuration(){return this._animationDuration}get originalAnimationDuration(){return this._originalAnimationDuration}get start(){return this._start}get value(){return this._value}get end(){return this._end}get hasChangedSinceLastTick(){return this._hasChanged}get prevDeltaValue(){return this._prevDeltaValue}get prevDeltaTime(){return this._prevDeltaTime}get derivateAt0(){return this._easing===0?6.938247437862991:0}},M=x;M._activeInstances=[];var E=class extends M{constructor(e,t,i,r,s=b.EASE_OUT,a=o.ANIMATION_DURATION,n=!0){super(e,t,s,a,n);this._originalMin=this._min=i,this._originalMax=this._max=r}get min(){return this._min}get max(){return this._max}get originalMin(){return this._originalMin}get originalMax(){return this._originalMax}setMin(e){this._min=e;let t=l.clamp(this._start,this._min,this._max),i=l.clamp(this._end,this._min,this._max);super.reset(t,i)}setMax(e){this._max=e;let t=l.clamp(this._start,this._min,this._max),i=l.clamp(this._end,this._min,this._max);super.reset(t,i)}reset(e,t,i,r,s=!1){this._min=i!=null?i:this._min,this._max=r!=null?r:this._max;let a=e!=null?e:this._originalStart,n=s?l.clamp(a,this._min,this._max):a,h=t!=null?t:this._originalEnd,u=s?l.clamp(h,this._min,this._max):h;super.reset(n,u)}isPlaying(){return this.value!==this.end}};var R=class{constructor(e,t){this._isPointerDown=!1;this._mouseMoved=!0;this._pointer={downTimeStamp:null,startX:null,startY:null,prevX:null,prevY:null,prevDeltaX:0,prevDeltaY:0,prevTimeStamp:0,prevDeltaTime:1};this._minV=.01;this._maxV=3.14;this._u=new E(0,0,-Infinity,Infinity,void 0,o.DAMPING_DURATION);this._v=new E(Math.PI/2,Math.PI/2,this._minV,this._maxV,void 0,o.DAMPING_DURATION);this._pinch={startValue:{touchDistance:null,zoomValue:null},currentValue:{touchDistance:null,zoomValue:null}};this._forward=[-1,0,0];this._dampingTimeoutId=null;this._dampOnPointerUp=!1;this._prevSpeed=[];this._enabled=!1;this._autoRotation=[o.AUTOROTATION_SPEEDS.default,0];this.ignorePinch=e=>{e.touches.length>1&&e.preventDefault(),(o.isIOS||o.isMac)&&(e=e.originalEvent||e,e.scale!==1&&e.preventDefault())};this.preventDefault=e=>{e.preventDefault()};this.onWheel=e=>{e.preventDefault();let t=1.1,i=this._sceneManager.userZoomFactor,r=Math.sign(-e.deltaY)>0?i.end*t:i.end/t;i.setEnd(r,!0)};this.onMouseDown=e=>{e.button===o.MOUSE_BUTTON.LEFT&&this.onPointerDown(e.clientX,e.clientY)};this.onTouchStart=e=>{e.preventDefault(),e.touches.length===1?this.onPointerDown(e.touches[0].clientX,e.touches[0].clientY):e.touches.length===2?(this._pinch.startValue.touchDistance=this.getTouchDistance(e),this._pinch.startValue.zoomValue=this._sceneManager.userZoomFactor.value):this.onPointerUp()};this.onMouseMove=e=>{this.onPointerMove(e.clientX,e.clientY)};this.onTouchMove=e=>{e.preventDefault(),e.touches.length===1?this.onPointerMove(e.touches[0].clientX,e.touches[0].clientY):e.touches.length===2&&this._pinch.startValue.touchDistance?(this._pinch.currentValue.touchDistance=this.getTouchDistance(e),this._pinch.currentValue.zoomValue=this._pinch.currentValue.touchDistance/this._pinch.startValue.touchDistance*this._pinch.startValue.zoomValue,this._sceneManager.userZoomFactor.setEnd(this._pinch.currentValue.zoomValue)):this.onPointerUp()};this.onPointerUp=()=>{if(this._isPointerDown){let e=performance.now();this._domElement.classList.remove("rotating");let t=this._prevSpeed,i=v.lengthOfSquared(t);if(this._dampOnPointerUp&&!isNaN(i)&&0<i&&i<Infinity){this._dampOnPointerUp=!1;let r=this._u.derivateAt0,s=this._u.originalAnimationDuration,a=[s*t[0]/r,s*t[1]/r];this._u.setEnd(this._u.value+a[0]),this._v.setEnd(this._v.value+a[1])}}this._isPointerDown=!1,this._pointer.downTimeStamp=null,this._pointer.startX=null,this._pointer.startY=null,this._pointer.prevX=null,this._pointer.prevY=null,this._pointer.prevTimeStamp=0,this._pointer.prevDeltaX=0,this._pointer.prevDeltaY=0,this._pointer.prevDeltaTime=1,this._pinch.startValue.touchDistance=this._pinch.startValue.zoomValue=this._pinch.currentValue.touchDistance=this._pinch.currentValue.zoomValue=null};this.cancelDamping=()=>{this._dampOnPointerUp=!1};this._domElement=e,this._sceneManager=t,this.disableDefaultZoomGesture()}disableDefaultZoomGesture(){window.addEventListener("touchstart",this.ignorePinch,{passive:!1}),window.addEventListener("touchmove",this.ignorePinch,{passive:!1}),window.addEventListener("gesturestart",this.preventDefault,{passive:!1}),window.addEventListener("gesturechange",this.preventDefault,{passive:!1})}getTouchDistance(e){let t={x:e.touches[0].clientX,y:e.touches[0].clientY},i={x:e.touches[1].clientX,y:e.touches[1].clientY},r={x:i.x-t.x,y:i.y-t.y};return Math.sqrt(r.x*r.x+r.y*r.y)}onPointerDown(e,t){this.stopRotating(),this._isPointerDown=!0,this._mouseMoved=!1,this._pointer.startX=this._pointer.prevX=e,this._pointer.startY=this._pointer.prevY=t,this._pointer.downTimeStamp=performance.now(),this._pointer.prevTimeStamp=this._pointer.downTimeStamp,this._domElement.classList.add("rotating"),this._u.reset(this._u.value,this._u.value),this._v.reset(this._v.value,this._v.value)}onPointerMove(e,t){if(this._isPointerDown&&(this._mouseMoved=e!==this._pointer.prevX||t!==this._pointer.prevY,this._mouseMoved)){if(this._domElement.classList.add("rotating"),this._pointer.prevX!=null&&this._pointer.prevY!=null){let r=this._sceneManager.userZoomFactor.value,s=(e-this._pointer.prevX)*o.POINTER_SENSITIVITY/window.innerHeight/r,a=(t-this._pointer.prevY)*o.POINTER_SENSITIVITY/window.innerHeight/r,n=this._u.end-s,h=this._v.end-a,u=this._pointer.startX-e,m=this._pointer.startY-t;this._u.reset(n,n),this._v.reset(h,h)}this._pointer.prevDeltaX=e-this._pointer.prevX,this._pointer.prevDeltaY=t-this._pointer.prevY,this._pointer.prevX=e,this._pointer.prevY=t;let i=performance.now();this._pointer.prevDeltaTime=i-this._pointer.prevTimeStamp,this._pointer.prevTimeStamp=i,this._dampOnPointerUp=!0,clearTimeout(this._dampingTimeoutId),this._dampingTimeoutId=setTimeout(this.cancelDamping,100)}}setUVFromSphereSufracePoint(e){let t=Math.PI+Math.atan2(-e[2],-e[0]);this._u.reset(t,t);let i=Math.PI/2-Math.asin(e[1]);this._v.reset(i,i)}setHeadingAngle(e,t,i){this._u.reset(e,e),t?this._v.reset(this._v.value,this._v.value):this._v.reset(Math.PI/2,Math.PI/2),i&&(this._autoRotation[0]=0,this._autoRotation[1]=0)}updateRotationLimit(){let e=this._viewBox;if(e){let t=this._domElement.offsetWidth/this._domElement.offsetHeight,i=l.deg2rad(o.FOV),r=2*Math.atan(Math.tan(i/2)*t);if(e[2]-e[0]<1){let s=!1,a=2*Math.PI*(-.5+e[0]),n=2*Math.PI*(-.5+e[2]),h=a,u=n;if(s&&(h+=r/2,u-=r/2),u>h)this._u.setMin(h),this._u.setMax(u);else{let m=(a+n)/2;this._u.setMin(m),this._u.setMax(m)}}else this._u.setMin(this._u.originalMin),this._u.setMax(this._u.originalMax);if(e[3]-e[1]<1){let s=!1,a=Math.max(Math.PI-e[3]*Math.PI,this._minV),n=Math.min(Math.PI-e[1]*Math.PI,this._maxV),h=a,u=n;if(s&&(h+=i/2,u-=i/2),u>h)this._v.setMin(h),this._v.setMax(u);else{let m=(a+n)/2;this._v.setMin(m),this._v.setMax(m)}}else this._v.setMin(this._v.originalMin),this._v.setMax(this._v.originalMax)}}limitRotation(e){this._viewBox=e,this.updateRotationLimit()}setSize(){this.updateRotationLimit()}activate(){this._enabled||(this._enabled=!0,this.setUVFromSphereSufracePoint(this._forward),this._domElement.addEventListener("mousedown",this.onMouseDown),this._domElement.addEventListener("touchstart",this.onTouchStart),this._domElement.addEventListener("wheel",this.onWheel),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("mouseup",this.onPointerUp),window.addEventListener("touchend",this.onPointerUp),window.addEventListener("touchcancel",this.onPointerUp))}deactivate(){this._enabled&&(this._enabled=!1,this._isPointerDown=!1,this._domElement.classList.remove("rotating"),this._domElement.removeEventListener("mousedown",this.onMouseDown),this._domElement.removeEventListener("touchstart",this.onTouchStart),this._domElement.removeEventListener("wheel",this.onWheel),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("mouseup",this.onPointerUp),window.removeEventListener("touchend",this.onPointerUp),window.removeEventListener("touchcancel",this.onPointerUp))}stopRotating(){this._autoRotation[0]=0,this._autoRotation[1]=0,this._u.reset(this._u.value,this._u.value),this._v.reset(this._v.value,this._v.value)}update(){return(this._autoRotation[0]!==0||this._autoRotation[1]!==0)&&(this._u.reset(this._u.end+this._autoRotation[0]*_.deltaFrame,this._u.end+this._autoRotation[0]*_.deltaFrame),this._v.reset(this._v.end+this._autoRotation[1]*_.deltaFrame,this._v.end+this._autoRotation[1]*_.deltaFrame,void 0,void 0,!0)),(this._u.hasChangedSinceLastTick||this._v.hasChangedSinceLastTick)&&(this._prevSpeed[0]=this._u.prevDeltaValue/this._u.prevDeltaTime,this._prevSpeed[1]=this._v.prevDeltaValue/this._v.prevDeltaTime,this._forward=l.getSphereSurfacePointFromUV(this._u.value,this._v.value),this._sceneManager.needsRender=!0),this._forward}get autoRotation(){return this._autoRotation}get currentHeadingAngle(){let e=this._u.value%(2*Math.PI);return e<0?e+2*Math.PI:e}get forward(){return this._forward}};var F=class{constructor(e,t){this._webGLVersion=2;this._canvas=e,this._sceneManager=t}init(){let e={alpha:!1,antialias:!1};this._gl=this._canvas.getContext("webgl2",e)||this._canvas.getContext("experimental-webgl2",e);let t=!1;return this._gl||(this._webGLVersion=1,this._gl=this._canvas.getContext("webgl",e),this._gl&&(t=!!this._gl.getExtension("EXT_shader_texture_lod"))),this._gl?(this._gl.clearColor(.125,.25,.5,1),this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this._gl.enable(this._gl.BLEND),this._gl.blendFunc(this._gl.SRC_ALPHA,this._gl.DST_ALPHA),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._shader=new w(this._gl,this._webGLVersion,t),this.initGeometry(),this._gl.useProgram(this._shader.program),!0):!1}get maxTextureSize(){var e;return((e=this._gl)==null?void 0:e.getParameter(this._gl.MAX_TEXTURE_SIZE))||1}get isWebGL2Supported(){return this._webGLVersion>=2}setSize(e,t){if(this._gl){let i=window.devicePixelRatio,r=window.innerWidth*i,s=window.innerHeight*i;this._canvas.width=r,this._canvas.height=s,this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this._shader.setSize(e,t),this._sceneManager.needsRender=!0}}initAttribPointer(e){this._gl.vertexAttribPointer(e,3,this._gl.FLOAT,!1,3*Float32Array.BYTES_PER_ELEMENT,0)}initVertices(e){let t=this._gl.getAttribLocation(e,"vertPosition");this.initAttribPointer(t),this._gl.enableVertexAttribArray(t)}initGeometry(){let e=[-1,-1,0,1,-1,0,-1,1,0,1,1,0],t=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.initVertices(this._shader.program)}loadDefaultTexture(){this.loadTexture(w.defaultTextureData)}loadTexture(e){this._shader.loadTexture(e)}render(e,t){this._shader.render(e,t)}};var g=class{constructor(){this._domElement=document.createElement("div");this._canvas=document.createElement("canvas");this._forward=[0,0,-1];this._userZoomFactor=new E(o.DEFAULT_ZOOM_FACTOR,o.DEFAULT_ZOOM_FACTOR,o.MIN_ZOOM_FACTOR,4,b.EASE_OUT,o.TRANSITION_DURATION);this.needsRender=!0;this.onContextLost=e=>{e.preventDefault(),alert("WebGL Context Lost")};this.onWindowResize=()=>{let e=window.innerWidth,t=window.innerHeight;this._webGLRenderer.setSize(e,t),this._controls.setSize()};this.update=()=>{g._timeStamp=performance.now(),g._deltaFrame=g._timeStamp-g.prevTimeStamp,g.prevTimeStamp=g._timeStamp,this.needsRender=M.updateActiveOnes(g._timeStamp)||this.needsRender,this.needsRender&&(this._forward=this._controls.update(),this._webGLRenderer.render(this._forward,this._userZoomFactor.value),this.needsRender=!1)};this.animate=()=>{this.update(),requestAnimationFrame(this.animate)};this.init()}init(){try{this._domElement.classList.add("playGround"),this._domElement.appendChild(this._canvas),document.body.appendChild(this._domElement),this.initRenderers(),this.initControls(),window.addEventListener("resize",this.onWindowResize),this.onWindowResize(),this.animate()}catch(e){return!1}return!0}initRenderers(){this._webGLRenderer=new F(this._canvas,this),this._webGLRenderer.init(),this._canvas.addEventListener("webglcontextlost",this.onContextLost)}initControls(){this._controls=new R(this._canvas.parentElement,this),this._controls.activate()}loadPhotoSphere(e){this._controls.limitRotation(e.viewBox);let t=Math.max(o.MIN_ZOOM_FACTOR,e.textureData.width*(1.7/4e3)/(e.viewBox[2]-e.viewBox[0]));this._webGLRenderer.loadTexture(e),requestAnimationFrame(()=>{this._userZoomFactor.setEnd(Math.min(this._userZoomFactor.end,t)),setTimeout(()=>{this._userZoomFactor.setMax(t)},this._userZoomFactor.animationDuration)}),this.needsRender=!0}static get timeStamp(){return g._timeStamp}static get deltaFrame(){return g._deltaFrame}get userZoomFactor(){return this._userZoomFactor}get maxTextureSize(){return this._webGLRenderer.maxTextureSize}get isWebGL2Supported(){return this._webGLRenderer.isWebGL2Supported}get forward(){return this._forward}},_=g;_.prevTimeStamp=0,_._timeStamp=0,_._deltaFrame=1e3;var O=class{constructor(){this._dropManager=new A("image/jpeg");this.filesSelected=async e=>{let t=e[0];this._dropManager.destroy();let i=new _,r=await S.getImageForTexture(t,i.maxTextureSize,i.isWebGL2Supported);i.loadPhotoSphere({headingAngle:0,textureData:r.textureData,viewBox:r.viewBox})};this._dropManager.signals.filesSelected.add(this.filesSelected)}},Ae=new O;})();
